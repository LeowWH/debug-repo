function broadCast(a){var b=new android.content.Intent(android.content.Intent.ACTION_MEDIA_SCANNER_SCAN_FILE),c=android.net.Uri.fromFile(a);b.setData(c),appModule.android.foregroundActivity.sendBroadcast(b),alert("Image saved success.")}function saveToAlbum(a,b,c,d){var e=imageSource.fromBase64(a);if(e.ios){var f=NSObject.extend({"thisImage:hasBeenSavedInPhotoAlbumWithError:usingContextInfo:":function(a,b,c){b?alert("Image save failed. Please go setting check permission."):alert("Image save success.")}},{exposedMethods:{"thisImage:hasBeenSavedInPhotoAlbumWithError:usingContextInfo:":{returns:interop.types["void"],params:[UIImage,NSError,interop.Pointer]}}}),g=f["new"]();UIImageWriteToSavedPhotosAlbum(e.ios,g,"thisImage:hasBeenSavedInPhotoAlbumWithError:usingContextInfo:",null)}else if(e.android){var h=android.os.Environment.getExternalStoragePublicDirectory(android.os.Environment.DIRECTORY_PICTURES);if(!h.isDirectory())try{h.mkdir()}catch(i){i.printStackTrace()}var j=h+"/"+b;if(permissions.hasPermission(android.Manifest.permission.WRITE_EXTERNAL_STORAGE)){var k=e.saveToFile(j,c,d);k&&broadCast(new java.io.File(j))}else permissions.requestPermission(android.Manifest.permission.WRITE_EXTERNAL_STORAGE,"Save payment images").then(function(){var a=e.saveToFile(j,c,d);a&&broadCast(new java.io.File(j))},function(){alert("Image save failed.")})}}function setupWebViewInterface(){return mainUiFrame.android||mainUiFrame.ios?(oWebViewInterface=new webViewInterfaceModule.WebViewInterface(mainUiFrame,"~/"+molpaySdkUrl),oWebViewInterface.on("molpayCallback",function(a){inAppCallback(a)}),oWebViewInterface.on("molpayLoaded",function(){oWebViewInterface.callJSFunction("startMolpayJS",JSON.stringify(molpayPaymentDetails))}),mainUiFrame.visibility="visible",void(bankUiWindow.visibility="collapsed")):void setTimeout(function(){setupWebViewInterface()},1e3)}var webViewModule=require("ui/web-view"),webViewInterfaceModule=require("nativescript-webview-interface"),base64=require("base-64"),imageSource=require("image-source"),permissions=require("nativescript-permissions"),appModule=require("application"),isInternalDebugging=!1,moduleId="molpay-mobile-xdk-nativescript",wrapperVersion="0",molpaySdkUrl="molpay-mobile-xdk-www/index.html",mpopenmolpaywindow="mpopenmolpaywindow://",mptransactionresults="mptransactionresults://",mprunscriptonpopup="mprunscriptonpopup://",mpcloseallwindows="mpcloseallwindows://",mppinstructioncapture="mppinstructioncapture://",molpayresulturl="MOLPay/result.php",molpaynbepayurl="MOLPay/nbepay.php",molpayPaymentDetails,transactionResultCallback,mainUiFrame,bankUiWindow,molpayTransactionRequestFrame,molpayView,oWebViewInterface,resultCallback,molpayPaymentDetails,createBankUiWindow=function(a){var b="data:text/html;base64,"+a;bankUiWindow.url=b,bankUiWindow.visibility="visible",mainUiFrame.visibility="collapsed";var c=function(a){if(evaljs(mainUiFrame,"nativeWebRequestUrlUpdates({ 'requestPath':'"+a.url+"'})"),a&&a.url.indexOf(molpaynbepayurl)>-1){var b="window.open = function (open) {return function (url, name, features) {window.location = url;return window;};} (window.open);",c="window.close = function () {window.location.assign(window.location);};";evaljs(bankUiWindow,b),evaljs(bankUiWindow,c)}};bankUiWindow.on("loadFinished",c)},inAppCallback=function(a){var b,c;if(a&&a.indexOf(mpopenmolpaywindow)>-1)c=new RegExp(mpopenmolpaywindow,"g"),b=a.replace(c,""),b&&b.length>0&&createBankUiWindow(b);else if(a&&a.indexOf(mpcloseallwindows)>-1)bankUiWindow&&(evaljs(bankUiWindow,"window.location = 'about:blank';"),evaljs(bankUiWindow,"window.open('about:blank','_self').close();"),molpayView.removeChild(bankUiWindow),bankUiWindow=""),mainUiFrame.visibility="visible";else if(a&&a.indexOf(mppinstructioncapture)>-1){c=new RegExp(mppinstructioncapture,"g"),b=a.replace(c,"");var d=JSON.parse(base64.decode(b));saveToAlbum(d.base64ImageUrlData,d.filename,"PNG",100)}else if(a&&a.indexOf(mptransactionresults)>-1&&(c=new RegExp(mptransactionresults,"g"),b=a.replace(c,""),b&&b.length>0)){var e=base64.decode(b),f=JSON.stringify(JSON.parse(e));resultCallback(f)}if(a&&a.indexOf(mprunscriptonpopup)>-1&&(c=new RegExp(mprunscriptonpopup,"g"),b=a.replace(c,""),b&&b.length>0)){var g=base64.decode(b);evaljs(bankUiWindow,g)}},evaljs=function(a,b){if(a.ios)a.ios.stringByEvaluatingJavaScriptFromString(b);else if(a.android){var c="javascript:"+b;a.android.loadUrl(c)}},startMolpay=function(a,b,c,d){return c&&(resultCallback=c),a?(molpayView=a,molpayPaymentDetails=b,mainUiFrame=new webViewModule.WebView,bankUiWindow=new webViewModule.WebView,molpayView.addChild(mainUiFrame),molpayView.addChild(bankUiWindow),void setupWebViewInterface()):void(d&&d("Please make sure you have content view id molpay"))},closeMolpay=function(){evaljs(mainUiFrame,"closemolpay();")};exports.closeMolpay=closeMolpay,exports.startMolpay=startMolpay;